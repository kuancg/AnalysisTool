<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç›®æ ‡è·Ÿè¸ªè¯„æµ‹å·¥å…·</title>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1d4ed8;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg: #f8fafc;
            --card-bg: #ffffff;
            --text: #1e293b;
            --text-secondary: #64748b;
            --border: #e2e8f0;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 0.95rem;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 5px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-wrap: wrap;
        }
        
        .tab {
            flex: 1;
            min-width: 100px;
            padding: 12px 20px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: 8px;
            transition: all 0.2s;
        }
        
        .tab:hover {
            background: var(--bg);
        }
        
        .tab.active {
            background: var(--primary);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .card h2 {
            font-size: 1.25rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text);
        }
        
        .form-group input[type="text"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-weight: normal;
        }
        
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg);
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: #f0f7ff;
        }
        
        .upload-area.dragover {
            border-color: var(--primary);
            background: #e0efff;
        }
        
        .upload-area p {
            color: var(--text-secondary);
            margin-top: 10px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-success:hover {
            opacity: 0.9;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            opacity: 0.9;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .status-box {
            background: var(--bg);
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .status-box h4 {
            margin-bottom: 10px;
            color: var(--text);
        }
        
        .status-item {
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }
        
        .status-item:last-child {
            border-bottom: none;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.95rem;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
        
        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border: 1px solid #bfdbfe;
        }
        
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }
        
        table th {
            background: var(--bg);
            font-weight: 600;
        }
        
        table tr:hover {
            background: var(--bg);
        }
        
        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--bg);
            border-radius: 6px;
            cursor: pointer;
            font-weight: normal;
            font-size: 0.9rem;
        }
        
        .checkbox-group label:hover {
            background: #e2e8f0;
        }
        
        .plot-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .plot-container img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .range-container {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .range-container input[type="range"] {
            flex: 1;
        }
        
        .range-container span {
            min-width: 30px;
            text-align: center;
            font-weight: 500;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .color-picker-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 10px 0;
        }
        
        .color-picker-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg);
            border-radius: 6px;
        }
        
        .color-picker-item input[type="color"] {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        
        pre {
            background: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            font-size: 0.85rem;
        }
        
        .help-section {
            margin-bottom: 25px;
        }
        
        .help-section h3 {
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .help-section ul {
            margin-left: 20px;
            line-height: 1.8;
        }
        
        /* å¯æ’åºè¡¨æ ¼æ ·å¼ */
        .sortable-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .sortable-table th {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px;
        }
        
        .sortable-table th:hover {
            background: #e2e8f0;
        }
        
        .sortable-table th::after {
            content: 'â‡…';
            position: absolute;
            right: 8px;
            color: #94a3b8;
            font-size: 0.8rem;
        }
        
        .sortable-table th.sort-asc::after {
            content: 'â†‘';
            color: var(--primary);
        }
        
        .sortable-table th.sort-desc::after {
            content: 'â†“';
            color: var(--primary);
        }
        
        .sortable-table td, .sortable-table th {
            padding: 10px 12px;
            text-align: center;
            border: 1px solid var(--border);
        }
        
        .sortable-table th {
            background: var(--bg);
            font-weight: 600;
        }
        
        .sortable-table tbody tr:hover {
            background: #f0f7ff;
        }
        
        .sortable-table td:first-child {
            text-align: left;
            font-weight: 500;
        }
        
        .table-container {
            overflow-x: auto;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ¯ ç›®æ ‡è·Ÿè¸ªè¯„æµ‹å·¥å…·</h1>
        <p>æ”¯æŒOTBå’ŒORTrackè¯„æµ‹æ–¹æ³• | æ”¯æŒæ‰¹é‡æ•°æ®é›†å’Œå¤šç®—æ³•è¯„æµ‹</p>
    </div>
    
    <div class="container">
        <div class="tabs">
            <button class="tab active" data-tab="upload">ğŸ“¤ æ•°æ®ä¸Šä¼ </button>
            <button class="tab" data-tab="evaluate">ğŸ“Š è¯„æµ‹</button>
            <button class="tab" data-tab="visualize">ğŸ“ˆ å¯è§†åŒ–</button>
            <button class="tab" data-tab="drawbox">ğŸ–¼ï¸ ç»˜åˆ¶è·Ÿè¸ªæ¡†</button>
            <button class="tab" data-tab="export">ğŸ’¾ å¯¼å‡º</button>
            <button class="tab" data-tab="help">â“ å¸®åŠ©</button>
        </div>
        
        <!-- æ•°æ®ä¸Šä¼  -->
        <div id="upload" class="tab-content active">
            <!-- åºåˆ—åˆ—è¡¨ä¸Šä¼ ï¼ˆé¦–å…ˆä¸Šä¼ ï¼‰ -->
            <div class="card" style="border-left: 4px solid var(--primary); background: linear-gradient(to right, #f0f7ff, #ffffff);">
                <h2>ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šä¸Šä¼ è§†é¢‘åºåˆ—åˆ—è¡¨ï¼ˆæ¨èï¼‰</h2>
                <p style="margin-bottom: 15px; color: var(--text-secondary);">
                    é¦–å…ˆä¸Šä¼ æ¯ä¸ªæ•°æ®é›†çš„è§†é¢‘åºåˆ—åç§°åˆ—è¡¨ï¼Œç”¨äºéªŒè¯åç»­ä¸Šä¼ çš„GTã€è·Ÿè¸ªç»“æœã€å±æ€§æ˜¯å¦å®Œæ•´ã€‚
                    è¿™ä¸€æ­¥æ˜¯å¯é€‰çš„ï¼Œä½†å¼ºçƒˆå»ºè®®ä½¿ç”¨ï¼Œä»¥ç¡®ä¿æ‰€æœ‰åºåˆ—æ•°æ®éƒ½æ­£ç¡®ä¸Šä¼ ã€‚
                </p>
                
                <div class="form-group">
                    <label>ä¸Šä¼ æ¨¡å¼</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="seqlist_mode" value="single" checked>
                            å•æ•°æ®é›†ï¼ˆTXTæ–‡ä»¶ï¼Œæ¯è¡Œä¸€ä¸ªåºåˆ—åï¼‰
                        </label>
                        <label>
                            <input type="radio" name="seqlist_mode" value="batch">
                            æ‰¹é‡ä¸Šä¼ ï¼ˆZIPåŒ…å«å¤šä¸ªTXTï¼Œä»¥æ•°æ®é›†åå‘½åï¼‰
                        </label>
                    </div>
                </div>
                
                <div class="form-group" id="seqlist_dataset_name_group">
                    <label>æ•°æ®é›†åç§° <span style="color: var(--danger);">*</span></label>
                    <input type="text" id="seqlist_dataset_name" placeholder="ä¾‹å¦‚: UAV123">
                </div>
                
                <div class="upload-area" id="seqlist_upload_area">
                    <div style="font-size: 2rem;">ğŸ“‹</div>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ TXT/ZIPæ–‡ä»¶</p>
                    <p style="font-size: 0.85rem; margin-top: 5px;">å•æ•°æ®é›†: TXTæ–‡ä»¶ | æ‰¹é‡: ZIPæ–‡ä»¶</p>
                </div>
                <input type="file" id="seqlist_file" accept=".txt,.zip" style="display: none;">
                
                <button class="btn btn-primary" id="seqlist_upload_btn" style="margin-top: 15px; width: 100%;">
                    ä¸Šä¼ åºåˆ—åˆ—è¡¨
                </button>
                
                <div id="seqlist_status"></div>
            </div>
            
            <div class="grid-2">
                <!-- Ground Truthä¸Šä¼  -->
                <div class="card">
                    <h2>ğŸ“ Ground Truthä¸Šä¼ </h2>
                    
                    <div class="form-group">
                        <label>ä¸Šä¼ æ¨¡å¼</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="gt_mode" value="single" checked>
                                å•æ•°æ®é›†
                            </label>
                            <label>
                                <input type="radio" name="gt_mode" value="batch">
                                æ‰¹é‡ä¸Šä¼ 
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group" id="gt_dataset_name_group">
                        <label>æ•°æ®é›†åç§° <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="gt_dataset_name" placeholder="ä¾‹å¦‚: UAV123">
                    </div>
                    
                    <div class="upload-area" id="gt_upload_area">
                        <div style="font-size: 2rem;">ğŸ“‚</div>
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ZIPæ–‡ä»¶</p>
                    </div>
                    <input type="file" id="gt_file" accept=".zip" style="display: none;">
                    
                    <button class="btn btn-primary" id="gt_upload_btn" style="margin-top: 15px; width: 100%;">
                        ä¸Šä¼ Ground Truth
                    </button>
                    
                    <div id="gt_status"></div>
                </div>
                
                <!-- è·Ÿè¸ªç»“æœä¸Šä¼  -->
                <div class="card">
                    <h2>ğŸ“ è·Ÿè¸ªç»“æœä¸Šä¼ </h2>
                    
                    <div class="form-group">
                        <label>ä¸Šä¼ æ¨¡å¼</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="tr_mode" value="single" checked>
                                å•ç®—æ³•å•æ•°æ®é›†
                            </label>
                            <label>
                                <input type="radio" name="tr_mode" value="single_tracker">
                                å•ç®—æ³•å¤šæ•°æ®é›†
                            </label>
                            <label>
                                <input type="radio" name="tr_mode" value="batch">
                                å¤šç®—æ³•å¤šæ•°æ®é›†
                            </label>
                        </div>
                    </div>
                    
                    <div id="tr_single_fields">
                        <div class="form-group">
                            <label>ç®—æ³•åç§° <span style="color: var(--danger);">*</span></label>
                            <input type="text" id="tr_tracker_name" placeholder="ä¾‹å¦‚: SiamFC">
                        </div>
                        <div class="form-group" id="tr_dataset_field">
                            <label>æ•°æ®é›†åç§° <span style="color: var(--danger);">*</span></label>
                            <input type="text" id="tr_dataset_name" placeholder="ä¾‹å¦‚: UAV123">
                        </div>
                    </div>
                    
                    <div id="tr_mode_hint" class="alert alert-info" style="margin-bottom: 15px; display: none;"></div>
                    
                    <div class="upload-area" id="tr_upload_area">
                        <div style="font-size: 2rem;">ğŸ“‚</div>
                        <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ZIPæ–‡ä»¶</p>
                    </div>
                    <input type="file" id="tr_file" accept=".zip" style="display: none;">
                    
                    <button class="btn btn-primary" id="tr_upload_btn" style="margin-top: 15px; width: 100%;">
                        ä¸Šä¼ è·Ÿè¸ªç»“æœ
                    </button>
                    
                    <div id="tr_status"></div>
                </div>
            </div>
            
            <!-- å±æ€§é…ç½®ä¸Šä¼  -->
            <div class="card">
                <h2>ğŸ·ï¸ å±æ€§é…ç½®ä¸Šä¼ ï¼ˆå¯é€‰ï¼Œç”¨äºå±æ€§è¯„æµ‹å’Œé›·è¾¾å›¾ï¼‰</h2>
                
                <div class="form-group">
                    <label>ä¸Šä¼ æ¨¡å¼</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="att_mode" value="single" checked>
                            å•æ•°æ®é›†
                        </label>
                        <label>
                            <input type="radio" name="att_mode" value="batch">
                            æ‰¹é‡ä¸Šä¼ 
                        </label>
                    </div>
                </div>
                
                <div id="att_single_fields">
                    <div class="form-group">
                        <label>æ•°æ®é›†åç§° <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="att_dataset_name" placeholder="ä¾‹å¦‚: UAV123">
                    </div>
                    <div class="form-group">
                        <label>å±æ€§åç§°ï¼ˆé€—å·åˆ†éš”ï¼‰ <span style="color: var(--danger);">*</span></label>
                        <input type="text" id="att_names" placeholder="ä¾‹å¦‚: IV,SV,OCC,DEF,MB,FM,IPR,OPR,OV,BC,LR">
                    </div>
                </div>
                
                <div class="upload-area" id="att_upload_area">
                    <div style="font-size: 2rem;">ğŸ“‚</div>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ZIPæ–‡ä»¶</p>
                </div>
                <input type="file" id="att_file" accept=".zip" style="display: none;">
                
                <button class="btn btn-primary" id="att_upload_btn" style="margin-top: 15px;">
                    ä¸Šä¼ å±æ€§é…ç½®
                </button>
                
                <div id="att_status"></div>
            </div>
            
            <!-- æ•°æ®çŠ¶æ€ -->
            <div class="card">
                <h2>ğŸ“‹ å½“å‰æ•°æ®çŠ¶æ€</h2>
                <div id="data_status">
                    <p style="color: var(--text-secondary);">æš‚æ— æ•°æ®</p>
                </div>
                <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-warning" id="clear_memory_btn">
                        ğŸ”„ æ¸…ç©ºå†…å­˜æ•°æ®ï¼ˆä¿ç•™å­˜æ¡£ï¼‰
                    </button>
                    <button class="btn btn-danger" id="clear_all_btn">
                        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆå«å­˜æ¡£ï¼‰
                    </button>
                </div>
            </div>
        </div>
        
        <!-- è¯„æµ‹ -->
        <div id="evaluate" class="tab-content">
            <!-- å•æ•°æ®é›†è¯„æµ‹ -->
            <div class="card">
                <h2>âš™ï¸ å•æ•°æ®é›†è¯„æµ‹</h2>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>é€‰æ‹©æ•°æ®é›†</label>
                        <select id="eval_dataset">
                            <option value="">-- è¯·å…ˆä¸Šä¼ æ•°æ® --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>è¯„æµ‹æ–¹æ³•</label>
                        <select id="eval_method">
                            <option value="otb">OTBæ–¹æ³•</option>
                            <option value="ortrack">ORTrackæ–¹æ³•</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©ç®—æ³•ï¼ˆä¸é€‰åˆ™è¯„æµ‹å…¨éƒ¨ï¼‰</label>
                    <div id="tracker_checkboxes" class="checkbox-group">
                        <p style="color: var(--text-secondary);">è¯·å…ˆé€‰æ‹©æ•°æ®é›†</p>
                    </div>
                </div>
                
                <button class="btn btn-success" id="run_eval_btn" style="width: 100%;">
                    ğŸš€ è¿è¡Œè¯„æµ‹
                </button>
                
                <div id="eval_status"></div>
            </div>
            
            <!-- æ‰¹é‡è¯„æµ‹ -->
            <div class="card">
                <h2>ğŸ“¦ æ‰¹é‡è¯„æµ‹ï¼ˆå¤šæ•°æ®é›†ï¼‰</h2>
                <p style="margin-bottom: 15px; color: var(--text-secondary);">
                    åŒæ—¶è¯„æµ‹å¤šä¸ªæ•°æ®é›†ï¼Œè‡ªåŠ¨è®¡ç®—æ¯ä¸ªç®—æ³•åœ¨æ‰€æœ‰æ•°æ®é›†ä¸Šçš„å¹³å‡å€¼ã€‚
                </p>
                
                <div class="form-group">
                    <label>è¯„æµ‹æ–¹æ³•</label>
                    <select id="batch_eval_method">
                        <option value="otb">OTBæ–¹æ³•</option>
                        <option value="ortrack">ORTrackæ–¹æ³•</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©æ•°æ®é›†ï¼ˆè‡³å°‘é€‰æ‹©2ä¸ªï¼‰</label>
                    <div id="batch_dataset_checkboxes" class="checkbox-group">
                        <p style="color: var(--text-secondary);">è¯·å…ˆä¸Šä¼ æ•°æ®</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©ç®—æ³•ï¼ˆä¸é€‰åˆ™è¯„æµ‹æ‰€æœ‰å…±æœ‰ç®—æ³•ï¼‰</label>
                    <div id="batch_tracker_checkboxes" class="checkbox-group">
                        <p style="color: var(--text-secondary);">è¯·å…ˆé€‰æ‹©æ•°æ®é›†</p>
                    </div>
                </div>
                
                <button class="btn btn-success" id="run_batch_eval_btn" style="width: 100%;">
                    ğŸš€ è¿è¡Œæ‰¹é‡è¯„æµ‹
                </button>
                
                <div id="batch_eval_status"></div>
            </div>
            
            <!-- å•æ•°æ®é›†è¯„æµ‹ç»“æœ -->
            <div class="card" id="eval_results_card" style="display: none;">
                <h2>ğŸ“Š æ€»ä½“è¯„æµ‹ç»“æœ <span style="font-size: 0.8rem; color: var(--text-secondary);">(ç‚¹å‡»åˆ—å¤´æ’åº)</span></h2>
                <div id="eval_results"></div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" id="download_excel_btn">
                        ğŸ“¥ ä¸‹è½½Excelç»“æœ
                    </button>
                </div>
            </div>
            
            <div class="card" id="attr_results_card" style="display: none;">
                <h2>ğŸ·ï¸ å±æ€§è¯„æµ‹ç»“æœ <span style="font-size: 0.8rem; color: var(--text-secondary);">(ç‚¹å‡»åˆ—å¤´æ’åº)</span></h2>
                
                <div class="form-group">
                    <label>é€‰æ‹©æ˜¾ç¤ºæŒ‡æ ‡</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="attr_metric" value="auc" checked>
                            AUC (æˆåŠŸç‡)
                        </label>
                        <label>
                            <input type="radio" name="attr_metric" value="precision_20">
                            Precision@20 (ç²¾åº¦)
                        </label>
                    </div>
                </div>
                
                <div id="attr_results"></div>
            </div>
            
            <!-- æ‰¹é‡è¯„æµ‹ç»“æœ -->
            <div class="card" id="batch_results_card" style="display: none;">
                <h2>ğŸ“¦ æ‰¹é‡è¯„æµ‹ç»“æœ - å¹³å‡å€¼æ±‡æ€» <span style="font-size: 0.8rem; color: var(--text-secondary);">(ç‚¹å‡»åˆ—å¤´æ’åº)</span></h2>
                <div id="batch_avg_results"></div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-success" id="download_batch_excel_btn">
                        ğŸ“¥ ä¸‹è½½æ‰¹é‡è¯„æµ‹Excel
                    </button>
                </div>
            </div>
            
            <div class="card" id="batch_detail_card" style="display: none;">
                <h2>ğŸ“Š å„æ•°æ®é›†è¯¦ç»†ç»“æœ</h2>
                <div id="batch_detail_results"></div>
            </div>
        </div>
        
        <!-- å¯è§†åŒ– -->
        <div id="visualize" class="tab-content">
            <div class="card">
                <h2>ğŸ“ˆ å›¾è¡¨é…ç½®</h2>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>å›¾è¡¨ç±»å‹</label>
                        <select id="plot_type">
                            <option value="success">æˆåŠŸç‡æ›²çº¿</option>
                            <option value="precision">ç²¾åº¦æ›²çº¿</option>
                            <option value="norm_precision">å½’ä¸€åŒ–ç²¾åº¦æ›²çº¿ï¼ˆä»…ORTrackï¼‰</option>
                            <option value="attr_success">å±æ€§æˆåŠŸç‡æ›²çº¿</option>
                            <option value="attr_precision">å±æ€§ç²¾åº¦æ›²çº¿</option>
                            <option value="radar">é›·è¾¾å›¾</option>
                            <option value="iou_curve">IoUæ›²çº¿å¯¹æ¯”ï¼ˆå•åºåˆ—ï¼‰</option>
                            <option value="center_error_curve">ä¸­å¿ƒè¯¯å·®æ›²çº¿å¯¹æ¯”ï¼ˆå•åºåˆ—ï¼‰</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>æ˜¾ç¤ºç®—æ³•æ•°é‡</label>
                        <div class="range-container">
                            <input type="range" id="rank_num" min="1" max="30" value="10">
                            <span id="rank_num_val">10</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>å›¾ä¾‹å­—ä½“å¤§å°</label>
                    <div class="range-container">
                        <input type="range" id="legend_fontsize" min="6" max="20" value="10">
                        <span id="legend_fontsize_val">10</span>
                    </div>
                </div>
                
                <!-- å±æ€§é€‰æ‹©ï¼ˆå±æ€§å›¾ç”¨ï¼‰ -->
                <div class="form-group" id="attr_select_group" style="display: none;">
                    <label>é€‰æ‹©å±æ€§</label>
                    <select id="attr_select">
                        <option value="">-- è¯·å…ˆè¿›è¡Œè¯„æµ‹ --</option>
                    </select>
                </div>
                
                <!-- é›·è¾¾å›¾é…ç½® -->
                <div id="radar_config" style="display: none;">
                    <div class="form-group">
                        <label>é€‰æ‹©è¦æ˜¾ç¤ºçš„å±æ€§ï¼ˆè‡³å°‘é€‰æ‹©3ä¸ªï¼‰</label>
                        <div id="radar_attr_checkboxes" class="checkbox-group">
                            <p style="color: var(--text-secondary);">è¯·å…ˆè¿›è¡Œè¯„æµ‹</p>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>è¯„æµ‹æŒ‡æ ‡</label>
                        <select id="radar_metric">
                            <option value="auc">AUC</option>
                            <option value="precision_20">Precision@20</option>
                        </select>
                    </div>
                </div>
                
                <!-- IoUæ›²çº¿é…ç½® -->
                <div id="iou_config" style="display: none;">
                    <div class="form-group">
                        <label>é€‰æ‹©è§†é¢‘åºåˆ—</label>
                        <select id="seq_select">
                            <option value="">-- è¯·å…ˆè¿›è¡Œè¯„æµ‹ --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>é€‰æ‹©è¦å¯¹æ¯”çš„ç®—æ³•</label>
                        <div id="iou_tracker_checkboxes" class="checkbox-group">
                            <p style="color: var(--text-secondary);">è¯·å…ˆè¿›è¡Œè¯„æµ‹</p>
                        </div>
                    </div>
                </div>
                
                <!-- è‡ªå®šä¹‰é¢œè‰²é…ç½® -->
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="enable_custom_colors"> 
                        å¯ç”¨è‡ªå®šä¹‰ç®—æ³•é¢œè‰²
                    </label>
                </div>
                
                <div id="custom_colors_config" style="display: none;">
                    <div class="form-group">
                        <label>ä¸ºæ¯ä¸ªç®—æ³•é€‰æ‹©é¢œè‰²</label>
                        <div id="tracker_color_pickers" class="color-picker-group">
                            <p style="color: var(--text-secondary);">è¯·å…ˆè¿›è¡Œè¯„æµ‹</p>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-primary" id="generate_plot_btn" style="width: 100%;">
                    ğŸ¨ ç”Ÿæˆå›¾è¡¨
                </button>
                
                <div id="plot_status"></div>
            </div>
            
            <div class="card" id="plot_result_card" style="display: none;">
                <h2>ğŸ“Š å›¾è¡¨ç»“æœ</h2>
                <div class="plot-container" id="plot_container"></div>
                <button class="btn btn-success" id="download_plot_btn" style="margin-top: 15px;">
                    ğŸ’¾ ä¸‹è½½å›¾è¡¨
                </button>
            </div>
        </div>
        
        <!-- ç»˜åˆ¶è·Ÿè¸ªæ¡† -->
        <div id="drawbox" class="tab-content">
            <div class="card">
                <h2>ğŸ–¼ï¸ è·Ÿè¸ªæ¡†ç»˜åˆ¶é…ç½®</h2>
                <p style="margin-bottom: 20px; color: var(--text-secondary);">
                    å°†è·Ÿè¸ªç»“æœç»˜åˆ¶åˆ°åŸå§‹å›¾åƒä¸Šï¼Œç”Ÿæˆå¸¦æœ‰è·Ÿè¸ªæ¡†çš„å¯è§†åŒ–å›¾åƒã€‚æ”¯æŒæ‰¹é‡é€‰æ‹©å¤šä¸ªç®—æ³•å’Œåºåˆ—ã€‚
                </p>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>é€‰æ‹©æ•°æ®é›†</label>
                        <select id="draw_dataset">
                            <option value="">-- è¯·å…ˆä¸Šä¼ æ•°æ® --</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>çº¿æ¡ç²—ç»†</label>
                        <div class="range-container">
                            <input type="range" id="draw_line_width" min="1" max="5" value="2">
                            <span id="draw_line_width_val">2</span>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>å›¾åƒæ ¹ç›®å½•ï¼ˆåŒ…å«å„åºåˆ—å›¾åƒçš„æ–‡ä»¶å¤¹ï¼‰</label>
                    <input type="text" id="draw_image_path" placeholder="ä¾‹å¦‚: /path/to/UAV123/data_seq/UAV123">
                    <small style="color: var(--text-secondary);">ç›®å½•ç»“æ„åº”ä¸º: æ ¹ç›®å½•/åºåˆ—å/å›¾åƒæ–‡ä»¶</small>
                </div>
                
                <div class="form-group">
                    <label>è¾“å‡ºç›®å½•ï¼ˆç»˜åˆ¶ç»“æœä¿å­˜ä½ç½®ï¼‰</label>
                    <input type="text" id="draw_output_path" placeholder="ä¾‹å¦‚: /path/to/output">
                </div>
                
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="draw_gt" checked>
                        ç»˜åˆ¶Ground Truth (ç»¿è‰²)
                    </label>
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©è¦ç»˜åˆ¶çš„ç®—æ³•</label>
                    <div id="draw_tracker_checkboxes" class="checkbox-group">
                        <p style="color: var(--text-secondary);">è¯·å…ˆé€‰æ‹©æ•°æ®é›†</p>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>é€‰æ‹©è¦ç»˜åˆ¶çš„åºåˆ—</label>
                    <div style="margin-bottom: 10px;">
                        <button class="btn btn-primary" id="draw_select_all_seq" style="padding: 6px 12px; font-size: 0.85rem;">å…¨é€‰</button>
                        <button class="btn btn-primary" id="draw_deselect_all_seq" style="padding: 6px 12px; font-size: 0.85rem;">å–æ¶ˆå…¨é€‰</button>
                    </div>
                    <div id="draw_seq_checkboxes" class="checkbox-group" style="max-height: 300px; overflow-y: auto;">
                        <p style="color: var(--text-secondary);">è¯·å…ˆé€‰æ‹©æ•°æ®é›†</p>
                    </div>
                </div>
                
                <!-- è‡ªå®šä¹‰é¢œè‰² -->
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="draw_enable_custom_colors"> 
                        è‡ªå®šä¹‰ç®—æ³•é¢œè‰²
                    </label>
                </div>
                
                <div id="draw_custom_colors_config" style="display: none;">
                    <div class="form-group">
                        <label>ä¸ºæ¯ä¸ªç®—æ³•é€‰æ‹©é¢œè‰²</label>
                        <div id="draw_tracker_color_pickers" class="color-picker-group">
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-success" id="draw_bbox_btn" style="width: 100%;">
                    ğŸ¨ å¼€å§‹ç»˜åˆ¶
                </button>
                
                <div id="draw_status"></div>
            </div>
            
            <div class="card" id="draw_result_card" style="display: none;">
                <h2>âœ… ç»˜åˆ¶ç»“æœ</h2>
                <div id="draw_results"></div>
            </div>
        </div>
        
        <!-- å¯¼å‡º -->
        <div id="export" class="tab-content">
            <div class="card">
                <h2>ğŸ’¾ å¯¼å‡ºè¯„æµ‹ç»“æœ</h2>
                
                <p style="margin-bottom: 20px; color: var(--text-secondary);">
                    å¯¼å‡ºå°†ç”ŸæˆåŒ…å«æ‰€æœ‰å›¾è¡¨ï¼ˆæˆåŠŸç‡å›¾ã€ç²¾åº¦å›¾ã€å±æ€§å›¾ï¼‰å’ŒJSONæ ¼å¼ç»“æœæ•°æ®çš„ZIPå‹ç¼©åŒ…ã€‚
                </p>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label>æ˜¾ç¤ºç®—æ³•æ•°é‡</label>
                        <div class="range-container">
                            <input type="range" id="export_rank_num" min="1" max="30" value="10">
                            <span id="export_rank_num_val">10</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>å›¾ä¾‹å­—ä½“å¤§å°</label>
                        <div class="range-container">
                            <input type="range" id="export_legend_fontsize" min="6" max="20" value="10">
                            <span id="export_legend_fontsize_val">10</span>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-success" id="export_btn" style="width: 100%;">
                    ğŸ“¦ å¯¼å‡ºæ‰€æœ‰ç»“æœ
                </button>
                
                <div id="export_status"></div>
            </div>
        </div>
        
        <!-- å¸®åŠ© -->
        <div id="help" class="tab-content">
            <div class="card">
                <h2>ğŸ“– ä½¿ç”¨æŒ‡å—</h2>
                
                <div class="help-section">
                    <h3>1. Ground Truthæ–‡ä»¶æ ¼å¼</h3>
                    <p>æ¯ä¸ªè§†é¢‘åºåˆ—å¯¹åº”ä¸€ä¸ªtxtæ–‡ä»¶ï¼Œæ¯è¡Œæ˜¯ä¸€å¸§çš„æ ‡æ³¨æ¡†ï¼š</p>
                    <pre>x,y,w,h
x,y,w,h
...</pre>
                    <p style="margin-top: 10px;">å…¶ä¸­ x,y æ˜¯å·¦ä¸Šè§’åæ ‡ï¼Œw,h æ˜¯å®½åº¦å’Œé«˜åº¦ã€‚</p>
                </div>
                
                <div class="help-section">
                    <h3>2. è·Ÿè¸ªç»“æœæ–‡ä»¶æ ¼å¼</h3>
                    <p>ä¸Ground Truthæ ¼å¼ç›¸åŒï¼Œæ¯ä¸ªåºåˆ—ä¸€ä¸ªtxtæ–‡ä»¶ã€‚</p>
                </div>
                
                <div class="help-section">
                    <h3>3. å±æ€§æ–‡ä»¶æ ¼å¼</h3>
                    <p>æ¯ä¸ªè§†é¢‘åºåˆ—å¯¹åº”ä¸€ä¸ªtxtæ–‡ä»¶ï¼Œå†…å®¹æ˜¯0/1ç»„æˆçš„æ•°ç»„ï¼Œè¡¨ç¤ºæ˜¯å¦åŒ…å«å¯¹åº”å±æ€§ï¼š</p>
                    <pre>1,0,1,0,1,1,0,0,1,0,0</pre>
                    <p style="margin-top: 10px;">ä½ç½®é¡ºåºä¸å±æ€§åç§°åˆ—è¡¨ä¸€è‡´ã€‚</p>
                </div>
                
                <div class="help-section">
                    <h3>4. æ‰¹é‡ä¸Šä¼ ç›®å½•ç»“æ„</h3>
                    
                    <h4 style="margin: 15px 0 10px;">Ground Truthæ‰¹é‡ä¸Šä¼ ï¼š</h4>
                    <pre>upload.zip/
â”œâ”€â”€ UAV123/
â”‚   â”œâ”€â”€ bike1.txt
â”‚   â”œâ”€â”€ bike2.txt
â”‚   â””â”€â”€ ...
â”œâ”€â”€ DTB70/
â”‚   â”œâ”€â”€ Animal1.txt
â”‚   â””â”€â”€ ...
â””â”€â”€ ...</pre>
                    
                    <h4 style="margin: 15px 0 10px;">è·Ÿè¸ªç»“æœ - å•ç®—æ³•å¤šæ•°æ®é›†ä¸Šä¼ ï¼š</h4>
                    <pre>upload.zip/
â”œâ”€â”€ UAV123/
â”‚   â”œâ”€â”€ bike1.txt
â”‚   â”œâ”€â”€ building1.txt
â”‚   â””â”€â”€ ...
â”œâ”€â”€ DTB70/
â”‚   â”œâ”€â”€ Animal1.txt
â”‚   â””â”€â”€ ...
â””â”€â”€ ...</pre>
                    <p style="font-size: 0.9rem; color: var(--text-secondary);">
                        é€‚åˆæ–°å¢å•ä¸ªç®—æ³•çš„ç»“æœï¼Œéœ€è¦åœ¨è¡¨å•ä¸­å¡«å†™ç®—æ³•åç§°
                    </p>
                    
                    <h4 style="margin: 15px 0 10px;">è·Ÿè¸ªç»“æœ - å¤šç®—æ³•å¤šæ•°æ®é›†ä¸Šä¼ ï¼š</h4>
                    <pre>upload.zip/
â”œâ”€â”€ SiamFC/
â”‚   â”œâ”€â”€ UAV123/
â”‚   â”‚   â”œâ”€â”€ bike1.txt
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ DTB70/
â”‚       â””â”€â”€ ...
â”œâ”€â”€ DiMP/
â”‚   â””â”€â”€ ...
â””â”€â”€ ...</pre>
                    
                    <h4 style="margin: 15px 0 10px;">å±æ€§é…ç½®æ‰¹é‡ä¸Šä¼ ï¼š</h4>
                    <pre>upload.zip/
â”œâ”€â”€ UAV123/
â”‚   â”œâ”€â”€ att_info.txt    # å†…å®¹: IV,SV,OCC,DEF,MB,...
â”‚   â”œâ”€â”€ bike1.txt       # å†…å®¹: 1,0,1,0,...
â”‚   â””â”€â”€ ...
â””â”€â”€ ...</pre>
                </div>
            </div>
            
            <div class="card">
                <h2>ğŸ“Š OTBä¸ORTrackæ–¹æ³•å¯¹æ¯”</h2>
                
                <table>
                    <tr>
                        <th>æ–¹é¢</th>
                        <th>OTBæ–¹æ³•</th>
                        <th>ORTrackæ–¹æ³•</th>
                    </tr>
                    <tr>
                        <td>ä¸»è¦æŒ‡æ ‡</td>
                        <td>AUC, Precision@20</td>
                        <td>AUC, Precision@20, Norm Precision@20, OP50, OP75</td>
                    </tr>
                    <tr>
                        <td>å½’ä¸€åŒ–ç²¾åº¦</td>
                        <td>æ— </td>
                        <td>æœ‰ï¼ˆé™¤ä»¥ç›®æ ‡å°ºå¯¸ï¼‰</td>
                    </tr>
                    <tr>
                        <td>ç»“æœèŒƒå›´</td>
                        <td>0~1ï¼ˆæ¯”ä¾‹ï¼‰</td>
                        <td>0~100ï¼ˆç™¾åˆ†æ¯”ï¼‰</td>
                    </tr>
                    <tr>
                        <td>IoUè®¡ç®—</td>
                        <td colspan="2">å®Œå…¨ç›¸åŒï¼šintersection / (areaA + areaB - intersection)</td>
                    </tr>
                    <tr>
                        <td>ä¸­å¿ƒè®¡ç®—</td>
                        <td colspan="2">å®Œå…¨ç›¸åŒï¼šx + (w-1)/2, y + (h-1)/2</td>
                    </tr>
                </table>
            </div>
            
            <div class="card">
                <h2>ğŸ¯ æ”¯æŒçš„æ•°æ®é›†</h2>
                <ul style="margin-left: 20px; line-height: 2;">
                    <li>UAV123 / UAV123@10fps</li>
                    <li>VisDrone</li>
                    <li>DTB70</li>
                    <li>UAVDT</li>
                    <li>UAVTrack112</li>
                    <li>OTB50 / OTB100</li>
                    <li>LaSOT</li>
                    <li>å…¶ä»–ç¬¦åˆæ ¼å¼çš„æ•°æ®é›†</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨å±€çŠ¶æ€
        let currentSessionId = null;
        let currentMethod = 'otb';
        let availableAttributes = [];
        let currentPlotImage = null;
        let evaluationData = null;  // ä¿å­˜å®Œæ•´è¯„æµ‹æ•°æ®
        
        // æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById(tab.dataset.tab).classList.add('active');
            });
        });
        
        // ä¸Šä¼ åŒºåŸŸå¤„ç†
        function setupUploadArea(areaId, inputId) {
            const area = document.getElementById(areaId);
            const input = document.getElementById(inputId);
            
            area.addEventListener('click', () => input.click());
            
            area.addEventListener('dragover', (e) => {
                e.preventDefault();
                area.classList.add('dragover');
            });
            
            area.addEventListener('dragleave', () => {
                area.classList.remove('dragover');
            });
            
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                if (e.dataTransfer.files.length > 0) {
                    input.files = e.dataTransfer.files;
                    area.querySelector('p').textContent = 'å·²é€‰æ‹©: ' + e.dataTransfer.files[0].name;
                }
            });
            
            input.addEventListener('change', () => {
                if (input.files.length > 0) {
                    area.querySelector('p').textContent = 'å·²é€‰æ‹©: ' + input.files[0].name;
                }
            });
        }
        
        setupUploadArea('gt_upload_area', 'gt_file');
        setupUploadArea('tr_upload_area', 'tr_file');
        setupUploadArea('att_upload_area', 'att_file');
        setupUploadArea('seqlist_upload_area', 'seqlist_file');
        
        // ä¸Šä¼ æ¨¡å¼åˆ‡æ¢
        document.querySelectorAll('input[name="seqlist_mode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const seqlistDsNameGroup = document.getElementById('seqlist_dataset_name_group');
                const seqlistFileInput = document.getElementById('seqlist_file');
                if (radio.value === 'single') {
                    seqlistDsNameGroup.style.display = 'block';
                    seqlistFileInput.accept = '.txt';
                } else {
                    seqlistDsNameGroup.style.display = 'none';
                    seqlistFileInput.accept = '.zip';
                }
            });
        });
        
        document.querySelectorAll('input[name="gt_mode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('gt_dataset_name_group').style.display = 
                    radio.value === 'single' ? 'block' : 'none';
            });
        });
        
        document.querySelectorAll('input[name="tr_mode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('tr_single_fields').style.display = 
                    radio.value === 'single' ? 'block' : 'none';
            });
        });
        
        document.querySelectorAll('input[name="att_mode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                document.getElementById('att_single_fields').style.display = 
                    radio.value === 'single' ? 'block' : 'none';
            });
        });
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(elementId, message, type) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        }
        
        // æ ¼å¼åŒ–éªŒè¯ç»“æœ
        function formatVerificationResult(verification) {
            if (!verification) return '';
            
            let html = '<div style="margin-top: 10px;">';
            
            for (const [key, result] of Object.entries(verification)) {
                if (!result.has_list) {
                    html += `<div class="alert alert-warning" style="font-size: 0.9rem; padding: 8px; margin: 5px 0;">
                        <strong>${key}</strong>: ${result.message}</div>`;
                } else if (result.verified) {
                    html += `<div class="alert alert-success" style="font-size: 0.9rem; padding: 8px; margin: 5px 0;">
                        <strong>${key}</strong>: ${result.message}</div>`;
                } else {
                    let details = `<strong>${key}</strong>: ${result.message}`;
                    if (result.missing && result.missing.length > 0) {
                        const missing = result.missing.length > 5 
                            ? result.missing.slice(0, 5).join(', ') + ` ...ç­‰${result.missing.length}ä¸ª`
                            : result.missing.join(', ');
                        details += `<br><span style="color: #e53e3e;">ç¼ºå°‘: ${missing}</span>`;
                    }
                    if (result.extra && result.extra.length > 0) {
                        const extra = result.extra.length > 5 
                            ? result.extra.slice(0, 5).join(', ') + ` ...ç­‰${result.extra.length}ä¸ª`
                            : result.extra.join(', ');
                        details += `<br><span style="color: #d69e2e;">å¤šä½™: ${extra}</span>`;
                    }
                    html += `<div class="alert alert-error" style="font-size: 0.9rem; padding: 8px; margin: 5px 0;">
                        ${details}</div>`;
                }
            }
            
            html += '</div>';
            return html;
        }
        
        // æ›´æ–°æ•°æ®çŠ¶æ€
        async function updateStatus() {
            try {
                const resp = await fetch('/api/status');
                const data = await resp.json();
                
                let html = '';
                
                // æ˜¾ç¤ºå·²ä¿å­˜æ•°æ®ä¿¡æ¯
                if (data.has_saved_data && data.saved_data_info) {
                    html += `<div class="alert alert-info" style="margin-bottom: 15px; padding: 10px;">
                        ğŸ’¾ <strong>æ•°æ®å·²è‡ªåŠ¨ä¿å­˜</strong> - ä¸‹æ¬¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½
                        <br><small>æœ€åä¿å­˜: ${data.saved_data_info.last_modified} | æ–‡ä»¶å¤§å°: ${data.saved_data_info.size_mb} MB</small>
                    </div>`;
                }
                
                // åºåˆ—åˆ—è¡¨çŠ¶æ€
                const seqLists = data.sequence_lists || {};
                const hasSeqLists = Object.keys(seqLists).length > 0;
                
                if (hasSeqLists) {
                    html += '<div class="status-box" style="border-left: 3px solid var(--primary); margin-bottom: 15px; padding-left: 10px;">';
                    html += '<h4>ğŸ“‹ å·²ä¸Šä¼ çš„åºåˆ—åˆ—è¡¨</h4>';
                    for (const [ds, info] of Object.entries(seqLists)) {
                        html += `<div class="status-item"><strong>${ds}</strong>: ${info.count}ä¸ªåºåˆ— âœ…</div>`;
                    }
                    html += '</div>';
                }
                
                if (data.datasets.length === 0) {
                    html += '<p style="color: var(--text-secondary);">æš‚æ— æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ Ground Truth</p>';
                } else {
                    html += '<div class="status-box"><h4>ğŸ“ æ•°æ®é›†</h4>';
                    for (const ds of data.datasets) {
                        const gtCount = data.gt_counts[ds] || 0;
                        const trackers = data.trackers_by_dataset[ds] || [];
                        const attrs = data.attributes_by_dataset[ds] || [];
                        
                        // æ£€æŸ¥æ˜¯å¦æœ‰åºåˆ—åˆ—è¡¨
                        const hasSeqList = ds in seqLists;
                        const expectedCount = hasSeqList ? seqLists[ds].count : null;
                        
                        let gtStatus = '';
                        if (hasSeqList) {
                            if (gtCount === expectedCount) {
                                gtStatus = ' âœ…';
                            } else {
                                gtStatus = ` âš ï¸(åº”ä¸º${expectedCount})`;
                            }
                        }
                        
                        html += `<div class="status-item">
                            <strong>${ds}</strong>: ${gtCount}ä¸ªåºåˆ—${gtStatus}`;
                        
                        if (trackers.length > 0) {
                            html += `<br>ã€€ç®—æ³•: ${trackers.join(', ')}`;
                        }
                        
                        if (attrs.length > 0) {
                            html += `<br>ã€€å±æ€§: ${attrs.join(', ')}`;
                        }
                        
                        html += '</div>';
                    }
                    html += '</div>';
                }
                
                document.getElementById('data_status').innerHTML = html;
                
                // æ›´æ–°è¯„æµ‹é¡µé¢çš„æ•°æ®é›†ä¸‹æ‹‰æ¡†
                const evalDataset = document.getElementById('eval_dataset');
                evalDataset.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ•°æ®é›† --</option>';
                for (const ds of data.datasets) {
                    evalDataset.innerHTML += `<option value="${ds}">${ds}</option>`;
                }
                
                // æ›´æ–°ç»˜åˆ¶é¡µé¢çš„æ•°æ®é›†ä¸‹æ‹‰æ¡†
                const drawDataset = document.getElementById('draw_dataset');
                drawDataset.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ•°æ®é›† --</option>';
                for (const ds of data.datasets) {
                    drawDataset.innerHTML += `<option value="${ds}">${ds}</option>`;
                }
                
                // æ›´æ–°æ‰¹é‡è¯„æµ‹çš„æ•°æ®é›†å¤é€‰æ¡†
                const batchDatasetCheckboxes = document.getElementById('batch_dataset_checkboxes');
                if (data.datasets.length < 2) {
                    batchDatasetCheckboxes.innerHTML = '<p style="color: var(--text-secondary);">éœ€è¦è‡³å°‘2ä¸ªæ•°æ®é›†æ‰èƒ½è¿›è¡Œæ‰¹é‡è¯„æµ‹</p>';
                } else {
                    batchDatasetCheckboxes.innerHTML = '';
                    for (const ds of data.datasets) {
                        const gtCount = data.gt_counts[ds] || 0;
                        batchDatasetCheckboxes.innerHTML += `
                            <label>
                                <input type="checkbox" value="${ds}" class="batch-dataset-cb">
                                ${ds} (${gtCount}åºåˆ—)
                            </label>
                        `;
                    }
                }
                
            } catch (e) {
                console.error('è·å–çŠ¶æ€å¤±è´¥:', e);
            }
        }
        
        // åºåˆ—åˆ—è¡¨ä¸Šä¼ 
        document.getElementById('seqlist_upload_btn').addEventListener('click', async () => {
            const file = document.getElementById('seqlist_file').files[0];
            if (!file) {
                showMessage('seqlist_status', 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }
            
            const mode = document.querySelector('input[name="seqlist_mode"]:checked').value;
            const datasetName = document.getElementById('seqlist_dataset_name').value.trim();
            
            if (mode === 'single' && !datasetName) {
                showMessage('seqlist_status', 'å•æ•°æ®é›†æ¨¡å¼éœ€è¦è¾“å…¥æ•°æ®é›†åç§°', 'error');
                return;
            }
            
            // éªŒè¯æ–‡ä»¶ç±»å‹
            if (mode === 'single' && !file.name.endsWith('.txt')) {
                showMessage('seqlist_status', 'å•æ•°æ®é›†æ¨¡å¼è¯·ä¸Šä¼ TXTæ–‡ä»¶', 'error');
                return;
            }
            if (mode === 'batch' && !file.name.endsWith('.zip')) {
                showMessage('seqlist_status', 'æ‰¹é‡æ¨¡å¼è¯·ä¸Šä¼ ZIPæ–‡ä»¶', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('mode', mode);
            formData.append('dataset_name', datasetName);
            
            const btn = document.getElementById('seqlist_upload_btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>ä¸Šä¼ ä¸­...';
            
            try {
                const resp = await fetch('/api/upload/sequence_list', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                
                if (data.success) {
                    let msg = `<strong>âœ… ${data.message}</strong><br>`;
                    if (data.details) {
                        msg += '<ul style="margin: 10px 0 0 20px;">';
                        for (const d of data.details) {
                            msg += `<li>${d}</li>`;
                        }
                        msg += '</ul>';
                    }
                    showMessage('seqlist_status', msg, 'success');
                    updateStatus();
                } else {
                    showMessage('seqlist_status', `âŒ ${data.error}`, 'error');
                }
            } catch (e) {
                showMessage('seqlist_status', `âŒ ä¸Šä¼ å¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ä¸Šä¼ åºåˆ—åˆ—è¡¨';
            }
        });
        
        // Ground Truthä¸Šä¼ 
        document.getElementById('gt_upload_btn').addEventListener('click', async () => {
            const file = document.getElementById('gt_file').files[0];
            if (!file) {
                showMessage('gt_status', 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }
            
            const mode = document.querySelector('input[name="gt_mode"]:checked').value;
            const datasetName = document.getElementById('gt_dataset_name').value.trim();
            
            if (mode === 'single' && !datasetName) {
                showMessage('gt_status', 'å•æ•°æ®é›†æ¨¡å¼éœ€è¦è¾“å…¥æ•°æ®é›†åç§°', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('mode', mode);
            formData.append('dataset_name', datasetName);
            
            const btn = document.getElementById('gt_upload_btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>ä¸Šä¼ ä¸­...';
            
            try {
                const resp = await fetch('/api/upload/groundtruth', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                
                if (data.success) {
                    let msg = `<strong>âœ… ${data.message}</strong><br>`;
                    if (data.details) {
                        msg += '<ul style="margin: 10px 0 0 20px;">';
                        for (const d of data.details) {
                            msg += `<li>${d}</li>`;
                        }
                        msg += '</ul>';
                    }
                    // æ˜¾ç¤ºéªŒè¯ç»“æœ
                    if (data.verification) {
                        msg += formatVerificationResult(data.verification);
                    }
                    showMessage('gt_status', msg, data.all_verified === false ? 'warning' : 'success');
                    updateStatus();
                } else {
                    showMessage('gt_status', `âŒ ${data.error}`, 'error');
                }
            } catch (e) {
                showMessage('gt_status', `âŒ ä¸Šä¼ å¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ä¸Šä¼ Ground Truth';
            }
        });
        
        // è·Ÿè¸ªç»“æœä¸Šä¼ æ¨¡å¼åˆ‡æ¢
        document.querySelectorAll('input[name="tr_mode"]').forEach(radio => {
            radio.addEventListener('change', () => {
                const mode = document.querySelector('input[name="tr_mode"]:checked').value;
                const singleFields = document.getElementById('tr_single_fields');
                const datasetField = document.getElementById('tr_dataset_field');
                const hintDiv = document.getElementById('tr_mode_hint');
                
                if (mode === 'batch') {
                    singleFields.style.display = 'none';
                    hintDiv.style.display = 'block';
                    hintDiv.innerHTML = `<strong>å¤šç®—æ³•å¤šæ•°æ®é›†æ¨¡å¼</strong><br>
                        ZIPç»“æ„: <code>tracker1/dataset1/seq.txt, tracker1/dataset2/seq.txt, tracker2/dataset1/seq.txt...</code><br>
                        é€‚åˆä¸€æ¬¡æ€§ä¸Šä¼ å¤šä¸ªç®—æ³•åœ¨å¤šä¸ªæ•°æ®é›†ä¸Šçš„ç»“æœ`;
                } else if (mode === 'single_tracker') {
                    singleFields.style.display = 'block';
                    datasetField.style.display = 'none';
                    hintDiv.style.display = 'block';
                    hintDiv.innerHTML = `<strong>å•ç®—æ³•å¤šæ•°æ®é›†æ¨¡å¼</strong><br>
                        ZIPç»“æ„: <code>dataset1/seq.txt, dataset2/seq.txt...</code><br>
                        é€‚åˆæ–°å¢ä¸€ä¸ªç®—æ³•åœ¨å¤šä¸ªæ•°æ®é›†ä¸Šçš„ç»“æœ`;
                } else {
                    singleFields.style.display = 'block';
                    datasetField.style.display = 'block';
                    hintDiv.style.display = 'block';
                    hintDiv.innerHTML = `<strong>å•ç®—æ³•å•æ•°æ®é›†æ¨¡å¼</strong><br>
                        ZIPç»“æ„: <code>seq1.txt, seq2.txt...</code><br>
                        é€‚åˆä¸Šä¼ å•ä¸ªç®—æ³•åœ¨å•ä¸ªæ•°æ®é›†ä¸Šçš„ç»“æœ`;
                }
            });
        });
        // åˆå§‹åŒ–æ˜¾ç¤ºæç¤º
        document.querySelector('input[name="tr_mode"]:checked').dispatchEvent(new Event('change'));
        
        // è·Ÿè¸ªç»“æœä¸Šä¼ 
        document.getElementById('tr_upload_btn').addEventListener('click', async () => {
            const file = document.getElementById('tr_file').files[0];
            if (!file) {
                showMessage('tr_status', 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }
            
            const mode = document.querySelector('input[name="tr_mode"]:checked').value;
            const trackerName = document.getElementById('tr_tracker_name').value.trim();
            const datasetName = document.getElementById('tr_dataset_name').value.trim();
            
            if (mode === 'single') {
                if (!trackerName) {
                    showMessage('tr_status', 'å•ç®—æ³•å•æ•°æ®é›†æ¨¡å¼éœ€è¦è¾“å…¥ç®—æ³•åç§°', 'error');
                    return;
                }
                if (!datasetName) {
                    showMessage('tr_status', 'å•ç®—æ³•å•æ•°æ®é›†æ¨¡å¼éœ€è¦è¾“å…¥æ•°æ®é›†åç§°', 'error');
                    return;
                }
            } else if (mode === 'single_tracker') {
                if (!trackerName) {
                    showMessage('tr_status', 'å•ç®—æ³•å¤šæ•°æ®é›†æ¨¡å¼éœ€è¦è¾“å…¥ç®—æ³•åç§°', 'error');
                    return;
                }
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('mode', mode);
            formData.append('tracker_name', trackerName);
            formData.append('dataset_name', datasetName);
            
            const btn = document.getElementById('tr_upload_btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>ä¸Šä¼ ä¸­...';
            
            try {
                const resp = await fetch('/api/upload/tracking_results', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                
                if (data.success) {
                    let msg = `<strong>âœ… ${data.message}</strong><br>`;
                    if (data.details) {
                        msg += '<ul style="margin: 10px 0 0 20px;">';
                        for (const d of data.details) {
                            msg += `<li>${d}</li>`;
                        }
                        msg += '</ul>';
                    }
                    // æ˜¾ç¤ºéªŒè¯ç»“æœ
                    if (data.verification) {
                        msg += formatVerificationResult(data.verification);
                    }
                    showMessage('tr_status', msg, data.all_verified === false ? 'warning' : 'success');
                    updateStatus();
                } else {
                    showMessage('tr_status', `âŒ ${data.error}`, 'error');
                }
            } catch (e) {
                showMessage('tr_status', `âŒ ä¸Šä¼ å¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ä¸Šä¼ è·Ÿè¸ªç»“æœ';
            }
        });
        
        // å±æ€§é…ç½®ä¸Šä¼ 
        document.getElementById('att_upload_btn').addEventListener('click', async () => {
            const file = document.getElementById('att_file').files[0];
            if (!file) {
                showMessage('att_status', 'è¯·å…ˆé€‰æ‹©æ–‡ä»¶', 'error');
                return;
            }
            
            const mode = document.querySelector('input[name="att_mode"]:checked').value;
            const datasetName = document.getElementById('att_dataset_name').value.trim();
            const attNames = document.getElementById('att_names').value.trim();
            
            if (mode === 'single') {
                if (!datasetName) {
                    showMessage('att_status', 'å•æ•°æ®é›†æ¨¡å¼éœ€è¦è¾“å…¥æ•°æ®é›†åç§°', 'error');
                    return;
                }
                if (!attNames) {
                    showMessage('att_status', 'å•æ•°æ®é›†æ¨¡å¼éœ€è¦è¾“å…¥å±æ€§åç§°', 'error');
                    return;
                }
            }
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('mode', mode);
            formData.append('dataset_name', datasetName);
            formData.append('attribute_names', attNames);
            
            const btn = document.getElementById('att_upload_btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>ä¸Šä¼ ä¸­...';
            
            try {
                const resp = await fetch('/api/upload/attributes', {
                    method: 'POST',
                    body: formData
                });
                const data = await resp.json();
                
                if (data.success) {
                    let msg = `<strong>âœ… ${data.message}</strong><br>`;
                    if (data.details) {
                        msg += '<ul style="margin: 10px 0 0 20px;">';
                        for (const d of data.details) {
                            msg += `<li>${d}</li>`;
                        }
                        msg += '</ul>';
                    }
                    // æ˜¾ç¤ºéªŒè¯ç»“æœ
                    if (data.verification) {
                        msg += formatVerificationResult(data.verification);
                    }
                    showMessage('att_status', msg, data.all_verified === false ? 'warning' : 'success');
                    updateStatus();
                } else {
                    showMessage('att_status', `âŒ ${data.error}`, 'error');
                }
            } catch (e) {
                showMessage('att_status', `âŒ ä¸Šä¼ å¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ä¸Šä¼ å±æ€§é…ç½®';
            }
        });
        
        // æ¸…ç©ºå†…å­˜æ•°æ®ï¼ˆä¿ç•™å­˜æ¡£ï¼‰
        document.getElementById('clear_memory_btn').addEventListener('click', async () => {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºå†…å­˜ä¸­çš„æ•°æ®å—ï¼Ÿ\n\nå·²ä¿å­˜çš„æ•°æ®æ–‡ä»¶ä¼šä¿ç•™ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶ä¼šè‡ªåŠ¨åŠ è½½ã€‚')) return;
            
            try {
                const resp = await fetch('/api/clear', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ delete_saved: false })
                });
                const data = await resp.json();
                if (data.success) {
                    showMessage('data_status', `âœ… ${data.message}`, 'success');
                    setTimeout(updateStatus, 1000);
                }
            } catch (e) {
                console.error('æ¸…ç©ºå¤±è´¥:', e);
            }
        });
        
        // æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ˆå«å­˜æ¡£ï¼‰
        document.getElementById('clear_all_btn').addEventListener('click', async () => {
            if (!confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿ\n\nè¿™å°†åŒæ—¶åˆ é™¤å·²ä¿å­˜çš„æ•°æ®æ–‡ä»¶ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            
            try {
                const resp = await fetch('/api/clear', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ delete_saved: true })
                });
                const data = await resp.json();
                if (data.success) {
                    showMessage('data_status', `âœ… ${data.message}`, 'success');
                    setTimeout(updateStatus, 1000);
                }
            } catch (e) {
                console.error('æ¸…ç©ºå¤±è´¥:', e);
            }
        });
        
        // æ•°æ®é›†é€‰æ‹©å˜åŒ– - æ›´æ–°ç®—æ³•åˆ—è¡¨
        document.getElementById('eval_dataset').addEventListener('change', async () => {
            const ds = document.getElementById('eval_dataset').value;
            const container = document.getElementById('tracker_checkboxes');
            
            if (!ds) {
                container.innerHTML = '<p style="color: var(--text-secondary);">è¯·å…ˆé€‰æ‹©æ•°æ®é›†</p>';
                return;
            }
            
            try {
                const resp = await fetch('/api/status');
                const data = await resp.json();
                
                const trackers = data.trackers_by_dataset[ds] || [];
                
                if (trackers.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary);">è¯¥æ•°æ®é›†æš‚æ— è·Ÿè¸ªç»“æœ</p>';
                    return;
                }
                
                container.innerHTML = '';
                for (const trk of trackers) {
                    container.innerHTML += `
                        <label>
                            <input type="checkbox" value="${trk}" checked>
                            ${trk}
                        </label>
                    `;
                }
            } catch (e) {
                container.innerHTML = '<p style="color: var(--danger);">åŠ è½½å¤±è´¥</p>';
            }
        });
        
        // è¿è¡Œè¯„æµ‹
        document.getElementById('run_eval_btn').addEventListener('click', async () => {
            const dataset = document.getElementById('eval_dataset').value;
            const method = document.getElementById('eval_method').value;
            
            if (!dataset) {
                showMessage('eval_status', 'è¯·é€‰æ‹©æ•°æ®é›†', 'error');
                return;
            }
            
            const checkedBoxes = document.querySelectorAll('#tracker_checkboxes input:checked');
            const trackers = Array.from(checkedBoxes).map(cb => cb.value);
            
            const btn = document.getElementById('run_eval_btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>è¯„æµ‹ä¸­...';
            
            try {
                const resp = await fetch('/api/evaluate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    cache: 'no-store',
                    body: JSON.stringify({
                        dataset_name: dataset,
                        tracker_names: trackers,
                        method: method
                    })
                });
                const data = await resp.json();
                
                if (data.success) {
                    currentSessionId = data.data.session_id;
                    currentMethod = method;
                    availableAttributes = data.data.attribute_names || [];
                    evaluationData = data.data;  // ä¿å­˜å®Œæ•´æ•°æ®
                    
                    let statusMsg = `âœ… ${data.message}`;
                    // æ˜¾ç¤ºéªŒè¯è­¦å‘Š
                    if (data.verification_warnings && data.verification_warnings.length > 0) {
                        statusMsg += '<div style="margin-top: 10px;"><strong>âš ï¸ æ•°æ®å®Œæ•´æ€§è­¦å‘Šï¼š</strong>';
                        for (const w of data.verification_warnings) {
                            statusMsg += `<div class="alert alert-warning" style="font-size: 0.9rem; padding: 8px; margin: 5px 0;">`;
                            statusMsg += `<strong>${w.type}${w.tracker ? '(' + w.tracker + ')' : ''}</strong>: ${w.message}`;
                            if (w.missing && w.missing.length > 0) {
                                const missing = w.missing.length > 3 
                                    ? w.missing.slice(0, 3).join(', ') + ` ...ç­‰${w.missing.length}ä¸ª`
                                    : w.missing.join(', ');
                                statusMsg += `<br><span style="color: #e53e3e;">ç¼ºå°‘: ${missing}</span>`;
                            }
                            if (w.extra && w.extra.length > 0) {
                                const extra = w.extra.length > 3 
                                    ? w.extra.slice(0, 3).join(', ') + ` ...ç­‰${w.extra.length}ä¸ª`
                                    : w.extra.join(', ');
                                statusMsg += `<br><span style="color: #d69e2e;">å¤šä½™: ${extra}</span>`;
                            }
                            statusMsg += '</div>';
                        }
                        statusMsg += '</div>';
                    }
                    showMessage('eval_status', statusMsg, data.verification_warnings ? 'warning' : 'success');
                    
                    // éšè—æ‰¹é‡è¯„æµ‹ç»“æœ
                    document.getElementById('batch_results_card').style.display = 'none';
                    document.getElementById('batch_detail_card').style.display = 'none';
                    
                    // æ¸²æŸ“æ€»ä½“ç»“æœè¡¨æ ¼
                    renderOverallResults(data.data, method);
                    
                    // æ¸²æŸ“å±æ€§ç»“æœè¡¨æ ¼
                    if (data.data.attribute_results && Object.keys(data.data.attribute_results).length > 0) {
                        document.getElementById('attr_results_card').style.display = 'block';
                        renderAttributeResults(data.data, method, 'auc');
                    } else {
                        document.getElementById('attr_results_card').style.display = 'none';
                    }
                    
                    document.getElementById('eval_results_card').style.display = 'block';
                    
                    // æ›´æ–°å¯è§†åŒ–é¡µé¢
                    updateVisualizationOptions();
                    
                } else {
                    showMessage('eval_status', `âŒ ${data.error}`, 'error');
                }
            } catch (e) {
                showMessage('eval_status', `âŒ è¯„æµ‹å¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸš€ è¿è¡Œè¯„æµ‹';
            }
        });
        
        // æ¸²æŸ“æ€»ä½“ç»“æœè¡¨æ ¼
        function renderOverallResults(data, method) {
            const trackers = data.trackers;
            
            // æ„å»ºè¡¨å¤´
            let headers = ['ç®—æ³•', 'AUC', 'Precision@20'];
            if (method === 'ortrack') {
                headers.push('Norm Prec@20', 'OP50', 'OP75');
            }
            headers.push('FPS');
            
            // æ„å»ºæ•°æ®è¡Œ
            const rows = Object.entries(trackers).map(([name, metrics]) => {
                const row = {
                    name: name,
                    auc: metrics.auc,
                    precision_20: metrics.precision_20,
                    fps: metrics.fps
                };
                if (method === 'ortrack') {
                    row.norm_precision_20 = metrics.norm_precision_20;
                    row.success_50 = metrics.success_50;
                    row.success_75 = metrics.success_75;
                }
                return row;
            });
            
            // æŒ‰AUCæ’åº
            rows.sort((a, b) => b.auc - a.auc);
            
            // ç”ŸæˆHTML
            let html = '<div class="table-container"><table class="sortable-table" id="overall_table">';
            html += '<thead><tr>';
            headers.forEach((h, i) => {
                const sortKey = i === 0 ? 'name' : 
                               i === 1 ? 'auc' : 
                               i === 2 ? 'precision_20' :
                               method === 'ortrack' ? (i === 3 ? 'norm_precision_20' : i === 4 ? 'success_50' : i === 5 ? 'success_75' : 'fps') : 'fps';
                html += `<th data-sort="${sortKey}" class="${i === 1 ? 'sort-desc' : ''}">${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            rows.forEach(row => {
                html += '<tr>';
                html += `<td>${row.name}</td>`;
                html += `<td>${row.auc}</td>`;
                html += `<td>${row.precision_20}</td>`;
                if (method === 'ortrack') {
                    html += `<td>${row.norm_precision_20}</td>`;
                    html += `<td>${row.success_50}</td>`;
                    html += `<td>${row.success_75}</td>`;
                }
                html += `<td>${row.fps !== null ? row.fps : '-'}</td>`;
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            // æ·»åŠ æç¤ºä¿¡æ¯
            if (data.has_attributes) {
                html += `<div class="alert alert-info" style="margin-top: 15px;">
                    âœ… æ£€æµ‹åˆ°å±æ€§é…ç½®ï¼Œå¯æŸ¥çœ‹ä¸‹æ–¹å±æ€§è¯„æµ‹ç»“æœã€‚
                    <br>å¯ç”¨å±æ€§: ${availableAttributes.join(', ')}
                </div>`;
            }
            
            if (data.attribute_warning) {
                html += `<div class="alert alert-warning" style="margin-top: 15px;">
                    âš ï¸ ${data.attribute_warning.replace(/\n/g, '<br>')}
                </div>`;
            }
            
            document.getElementById('eval_results').innerHTML = html;
            
            // æ·»åŠ æ’åºåŠŸèƒ½
            setupTableSorting('overall_table');
        }
        
        // æ¸²æŸ“å±æ€§ç»“æœè¡¨æ ¼
        function renderAttributeResults(data, method, metric) {
            const attrResults = data.attribute_results;
            const trackerNames = Object.keys(data.trackers);
            const attrNames = Object.keys(attrResults);
            
            if (attrNames.length === 0) return;
            
            // æ„å»ºè¡¨å¤´: ç®—æ³• + å„å±æ€§
            let headers = ['ç®—æ³•'].concat(attrNames.map(a => `${a}(${attrResults[a].num_seqs})`));
            
            // æ„å»ºæ•°æ®è¡Œ
            const rows = trackerNames.map(trk => {
                const row = { name: trk };
                attrNames.forEach(attr => {
                    if (attrResults[attr].trackers[trk]) {
                        row[attr] = attrResults[attr].trackers[trk][metric];
                    } else {
                        row[attr] = '-';
                    }
                });
                // è®¡ç®—å¹³å‡å€¼ç”¨äºæ’åº
                const values = attrNames.map(a => row[a]).filter(v => v !== '-');
                row._avg = values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : 0;
                return row;
            });
            
            // æŒ‰å¹³å‡å€¼æ’åº
            rows.sort((a, b) => b._avg - a._avg);
            
            // ç”ŸæˆHTML
            let html = '<div class="table-container"><table class="sortable-table" id="attr_table">';
            html += '<thead><tr>';
            headers.forEach((h, i) => {
                const sortKey = i === 0 ? 'name' : attrNames[i - 1];
                html += `<th data-sort="${sortKey}">${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            rows.forEach(row => {
                html += '<tr>';
                html += `<td>${row.name}</td>`;
                attrNames.forEach(attr => {
                    const val = row[attr];
                    html += `<td>${val !== '-' ? val : '-'}</td>`;
                });
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            document.getElementById('attr_results').innerHTML = html;
            
            // æ·»åŠ æ’åºåŠŸèƒ½
            setupTableSorting('attr_table');
        }
        
        // è¡¨æ ¼æ’åºåŠŸèƒ½
        function setupTableSorting(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const headers = table.querySelectorAll('th[data-sort]');
            
            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const sortKey = header.dataset.sort;
                    const isAsc = header.classList.contains('sort-asc');
                    
                    // æ¸…é™¤æ‰€æœ‰æ’åºæ ‡è®°
                    headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
                    
                    // è®¾ç½®æ–°çš„æ’åºæ ‡è®°
                    header.classList.add(isAsc ? 'sort-desc' : 'sort-asc');
                    
                    // æ’åºè¡¨æ ¼
                    sortTable(table, sortKey, !isAsc);
                });
            });
        }
        
        function sortTable(table, sortKey, ascending) {
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const headerCells = Array.from(table.querySelectorAll('th[data-sort]'));
            const colIndex = headerCells.findIndex(h => h.dataset.sort === sortKey);
            
            rows.sort((a, b) => {
                let aVal = a.cells[colIndex].textContent.trim();
                let bVal = b.cells[colIndex].textContent.trim();
                
                // å¤„ç†æ•°å­—å’Œå­—ç¬¦ä¸²
                if (aVal === '-') aVal = ascending ? Infinity : -Infinity;
                else if (!isNaN(parseFloat(aVal))) aVal = parseFloat(aVal);
                
                if (bVal === '-') bVal = ascending ? Infinity : -Infinity;
                else if (!isNaN(parseFloat(bVal))) bVal = parseFloat(bVal);
                
                if (typeof aVal === 'number' && typeof bVal === 'number') {
                    return ascending ? aVal - bVal : bVal - aVal;
                }
                return ascending ? String(aVal).localeCompare(String(bVal)) : String(bVal).localeCompare(String(aVal));
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // å±æ€§æŒ‡æ ‡åˆ‡æ¢
        document.querySelectorAll('input[name="attr_metric"]').forEach(radio => {
            radio.addEventListener('change', () => {
                if (evaluationData && evaluationData.attribute_results) {
                    renderAttributeResults(evaluationData, currentMethod, radio.value);
                }
            });
        });
        
        // Excelä¸‹è½½
        document.getElementById('download_excel_btn').addEventListener('click', async () => {
            if (!currentSessionId) {
                showMessage('eval_status', 'è¯·å…ˆè¿›è¡Œè¯„æµ‹', 'error');
                return;
            }
            
            const btn = document.getElementById('download_excel_btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>ç”Ÿæˆä¸­...';
            
            try {
                const resp = await fetch('/api/export_excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: currentSessionId })
                });
                
                if (resp.ok) {
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'benchmark_results.xlsx';
                    link.click();
                    URL.revokeObjectURL(url);
                } else {
                    const data = await resp.json();
                    showMessage('eval_status', `âŒ ${data.error}`, 'error');
                }
            } catch (e) {
                showMessage('eval_status', `âŒ ä¸‹è½½å¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“¥ ä¸‹è½½Excelç»“æœ';
            }
        });
        
        // ========== æ‰¹é‡è¯„æµ‹åŠŸèƒ½ ==========
        let batchSessionId = null;
        
        // æ‰¹é‡è¯„æµ‹æ•°æ®é›†é€‰æ‹©å˜åŒ– - æ›´æ–°å…±æœ‰ç®—æ³•åˆ—è¡¨
        document.getElementById('batch_dataset_checkboxes').addEventListener('change', async () => {
            const checkedDatasets = document.querySelectorAll('.batch-dataset-cb:checked');
            const datasetNames = Array.from(checkedDatasets).map(cb => cb.value);
            
            const container = document.getElementById('batch_tracker_checkboxes');
            
            if (datasetNames.length < 1) {
                container.innerHTML = '<p style="color: var(--text-secondary);">è¯·å…ˆé€‰æ‹©æ•°æ®é›†</p>';
                return;
            }
            
            try {
                const resp = await fetch('/api/status');
                const data = await resp.json();
                
                // æ‰¾å‡ºæ‰€æœ‰é€‰ä¸­æ•°æ®é›†çš„å…±æœ‰ç®—æ³•
                let commonTrackers = null;
                for (const ds of datasetNames) {
                    const dsTrackers = new Set(data.trackers_by_dataset[ds] || []);
                    if (commonTrackers === null) {
                        commonTrackers = dsTrackers;
                    } else {
                        commonTrackers = new Set([...commonTrackers].filter(t => dsTrackers.has(t)));
                    }
                }
                
                if (!commonTrackers || commonTrackers.size === 0) {
                    container.innerHTML = '<p style="color: var(--warning);">æ‰€é€‰æ•°æ®é›†æ²¡æœ‰å…±æœ‰ç®—æ³•</p>';
                    return;
                }
                
                container.innerHTML = '';
                for (const trk of commonTrackers) {
                    container.innerHTML += `
                        <label>
                            <input type="checkbox" value="${trk}" checked>
                            ${trk}
                        </label>
                    `;
                }
            } catch (e) {
                container.innerHTML = '<p style="color: var(--danger);">åŠ è½½å¤±è´¥</p>';
            }
        });
        
        // è¿è¡Œæ‰¹é‡è¯„æµ‹
        document.getElementById('run_batch_eval_btn').addEventListener('click', async () => {
            const method = document.getElementById('batch_eval_method').value;
            
            const checkedDatasets = document.querySelectorAll('.batch-dataset-cb:checked');
            const datasetNames = Array.from(checkedDatasets).map(cb => cb.value);
            
            if (datasetNames.length < 2) {
                showMessage('batch_eval_status', 'è¯·è‡³å°‘é€‰æ‹©2ä¸ªæ•°æ®é›†', 'error');
                return;
            }
            
            const checkedTrackers = document.querySelectorAll('#batch_tracker_checkboxes input:checked');
            const trackerNames = Array.from(checkedTrackers).map(cb => cb.value);
            
            const btn = document.getElementById('run_batch_eval_btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>æ‰¹é‡è¯„æµ‹ä¸­...';
            
            try {
                const resp = await fetch('/api/evaluate_batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dataset_names: datasetNames,
                        tracker_names: trackerNames,
                        method: method
                    })
                });
                const data = await resp.json();
                
                if (data.success) {
                    batchSessionId = data.data.session_id;
                    showMessage('batch_eval_status', `âœ… ${data.message}`, 'success');
                    
                    // éšè—å•ç‹¬è¯„æµ‹ç»“æœ
                    document.getElementById('eval_results_card').style.display = 'none';
                    document.getElementById('attr_results_card').style.display = 'none';
                    
                    // æ¸²æŸ“å¹³å‡å€¼ç»“æœ
                    renderBatchAvgResults(data.data, method);
                    
                    // æ¸²æŸ“å„æ•°æ®é›†è¯¦ç»†ç»“æœ
                    renderBatchDetailResults(data.data, method);
                    
                    document.getElementById('batch_results_card').style.display = 'block';
                    document.getElementById('batch_detail_card').style.display = 'block';
                } else {
                    showMessage('batch_eval_status', `âŒ ${data.error}`, 'error');
                }
            } catch (e) {
                showMessage('batch_eval_status', `âŒ æ‰¹é‡è¯„æµ‹å¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸš€ è¿è¡Œæ‰¹é‡è¯„æµ‹';
            }
        });
        
        // æ¸²æŸ“æ‰¹é‡è¯„æµ‹å¹³å‡å€¼ç»“æœ
        function renderBatchAvgResults(data, method) {
            const averages = data.averages;
            
            let headers = ['ç®—æ³•', 'æ•°æ®é›†æ•°', 'å¹³å‡AUC', 'å¹³å‡Precision@20'];
            if (method === 'ortrack') {
                headers.push('å¹³å‡Norm Prec@20');
            }
            
            let html = '<div class="table-container"><table class="sortable-table" id="batch_avg_table">';
            html += '<thead><tr>';
            headers.forEach((h, i) => {
                const sortKey = i === 0 ? 'name' : 
                               i === 1 ? 'datasets_count' : 
                               i === 2 ? 'avg_auc' : 
                               i === 3 ? 'avg_precision_20' : 'avg_norm_precision_20';
                html += `<th data-sort="${sortKey}" class="${i === 2 ? 'sort-desc' : ''}">${h}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // æŒ‰å¹³å‡AUCæ’åº
            const sorted = Object.entries(averages).sort((a, b) => b[1].avg_auc - a[1].avg_auc);
            
            sorted.forEach(([name, avg]) => {
                html += '<tr>';
                html += `<td>${name}</td>`;
                html += `<td>${avg.datasets_count}</td>`;
                html += `<td>${avg.avg_auc}</td>`;
                html += `<td>${avg.avg_precision_20}</td>`;
                if (method === 'ortrack') {
                    html += `<td>${avg.avg_norm_precision_20 || '-'}</td>`;
                }
                html += '</tr>';
            });
            
            html += '</tbody></table></div>';
            
            document.getElementById('batch_avg_results').innerHTML = html;
            setupTableSorting('batch_avg_table');
        }
        
        // æ¸²æŸ“æ‰¹é‡è¯„æµ‹å„æ•°æ®é›†è¯¦ç»†ç»“æœ
        function renderBatchDetailResults(data, method) {
            const datasets = data.datasets;
            
            let html = '';
            
            for (const [dsName, dsSummary] of Object.entries(datasets)) {
                html += `<div style="margin-bottom: 20px;">`;
                html += `<h4 style="margin-bottom: 10px;">${dsName} (${dsSummary.num_sequences}åºåˆ—)</h4>`;
                
                let headers = ['ç®—æ³•', 'AUC', 'Precision@20'];
                if (method === 'ortrack') {
                    headers.push('Norm Prec@20');
                }
                
                html += '<div class="table-container"><table class="sortable-table">';
                html += '<thead><tr>';
                headers.forEach(h => html += `<th>${h}</th>`);
                html += '</tr></thead><tbody>';
                
                const sorted = Object.entries(dsSummary.trackers).sort((a, b) => b[1].auc - a[1].auc);
                
                sorted.forEach(([name, metrics]) => {
                    html += '<tr>';
                    html += `<td>${name}</td>`;
                    html += `<td>${metrics.auc}</td>`;
                    html += `<td>${metrics.precision_20}</td>`;
                    if (method === 'ortrack') {
                        html += `<td>${metrics.norm_precision_20 || '-'}</td>`;
                    }
                    html += '</tr>';
                });
                
                html += '</tbody></table></div>';
                html += '</div>';
            }
            
            document.getElementById('batch_detail_results').innerHTML = html;
        }
        
        // æ‰¹é‡è¯„æµ‹Excelä¸‹è½½
        document.getElementById('download_batch_excel_btn').addEventListener('click', async () => {
            if (!batchSessionId) {
                showMessage('batch_eval_status', 'è¯·å…ˆè¿›è¡Œæ‰¹é‡è¯„æµ‹', 'error');
                return;
            }
            
            const btn = document.getElementById('download_batch_excel_btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>ç”Ÿæˆä¸­...';
            
            try {
                const resp = await fetch('/api/export_batch_excel', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ session_id: batchSessionId })
                });
                
                if (resp.ok) {
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'batch_benchmark_results.xlsx';
                    link.click();
                    URL.revokeObjectURL(url);
                } else {
                    const data = await resp.json();
                    showMessage('batch_eval_status', `âŒ ${data.error}`, 'error');
                }
            } catch (e) {
                showMessage('batch_eval_status', `âŒ ä¸‹è½½å¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“¥ ä¸‹è½½æ‰¹é‡è¯„æµ‹Excel';
            }
        });
        
        // æ›´æ–°å¯è§†åŒ–é€‰é¡¹
        async function updateVisualizationOptions() {
            const attrSelect = document.getElementById('attr_select');
            const radarCheckboxes = document.getElementById('radar_attr_checkboxes');
            const seqSelect = document.getElementById('seq_select');
            const iouTrackerCheckboxes = document.getElementById('iou_tracker_checkboxes');
            const colorPickers = document.getElementById('tracker_color_pickers');
            
            // æ›´æ–°å±æ€§é€‰æ‹©
            if (availableAttributes.length === 0) {
                attrSelect.innerHTML = '<option value="">-- æ— å¯ç”¨å±æ€§ --</option>';
                radarCheckboxes.innerHTML = '<p style="color: var(--text-secondary);">æ²¡æœ‰å¯ç”¨çš„å±æ€§æ•°æ®</p>';
            } else {
                attrSelect.innerHTML = '';
                radarCheckboxes.innerHTML = '';
                for (const attr of availableAttributes) {
                    attrSelect.innerHTML += `<option value="${attr}">${attr}</option>`;
                    radarCheckboxes.innerHTML += `
                        <label>
                            <input type="checkbox" value="${attr}" checked>
                            ${attr}
                        </label>
                    `;
                }
            }
            
            // è·å–çŠ¶æ€æ›´æ–°åºåˆ—å’Œç®—æ³•åˆ—è¡¨
            try {
                const resp = await fetch('/api/status');
                const data = await resp.json();
                
                const dataset = document.getElementById('eval_dataset').value;
                
                // æ›´æ–°åºåˆ—é€‰æ‹©
                const sequences = data.sequences_by_dataset[dataset] || [];
                seqSelect.innerHTML = '';
                if (sequences.length === 0) {
                    seqSelect.innerHTML = '<option value="">-- æ— å¯ç”¨åºåˆ— --</option>';
                } else {
                    for (const seq of sequences) {
                        seqSelect.innerHTML += `<option value="${seq}">${seq}</option>`;
                    }
                }
                
                // æ›´æ–°ç®—æ³•é€‰æ‹©ï¼ˆIoUæ›²çº¿ç”¨ï¼‰
                const trackers = data.trackers_by_dataset[dataset] || [];
                iouTrackerCheckboxes.innerHTML = '';
                colorPickers.innerHTML = '';
                
                if (trackers.length === 0) {
                    iouTrackerCheckboxes.innerHTML = '<p style="color: var(--text-secondary);">æ— å¯ç”¨ç®—æ³•</p>';
                    colorPickers.innerHTML = '<p style="color: var(--text-secondary);">æ— å¯ç”¨ç®—æ³•</p>';
                } else {
                    // é¢„å®šä¹‰é¢œè‰²
                    const defaultColors = [
                        '#ff0000', '#00ff00', '#0000ff', '#ff00ff', '#00ffff',
                        '#ffa500', '#800080', '#008080', '#ff69b4', '#32cd32'
                    ];
                    
                    for (let i = 0; i < trackers.length; i++) {
                        const trk = trackers[i];
                        const color = defaultColors[i % defaultColors.length];
                        
                        iouTrackerCheckboxes.innerHTML += `
                            <label>
                                <input type="checkbox" value="${trk}" checked>
                                ${trk}
                            </label>
                        `;
                        
                        colorPickers.innerHTML += `
                            <div class="color-picker-item">
                                <input type="color" id="color_${trk}" value="${color}">
                                <span>${trk}</span>
                            </div>
                        `;
                    }
                }
            } catch (e) {
                console.error('æ›´æ–°å¯è§†åŒ–é€‰é¡¹å¤±è´¥:', e);
            }
        }
        
        // å›¾è¡¨ç±»å‹åˆ‡æ¢
        document.getElementById('plot_type').addEventListener('change', () => {
            const plotType = document.getElementById('plot_type').value;
            
            document.getElementById('attr_select_group').style.display = 
                (plotType === 'attr_success' || plotType === 'attr_precision') ? 'block' : 'none';
            
            document.getElementById('radar_config').style.display = 
                plotType === 'radar' ? 'block' : 'none';
            
            document.getElementById('iou_config').style.display = 
                (plotType === 'iou_curve' || plotType === 'center_error_curve') ? 'block' : 'none';
        });
        
        // è‡ªå®šä¹‰é¢œè‰²å¼€å…³
        document.getElementById('enable_custom_colors').addEventListener('change', (e) => {
            document.getElementById('custom_colors_config').style.display = 
                e.target.checked ? 'block' : 'none';
        });
        
        // è·å–è‡ªå®šä¹‰é¢œè‰²é…ç½®
        function getTrackerColors() {
            if (!document.getElementById('enable_custom_colors').checked) {
                return null;
            }
            
            const colors = {};
            const colorInputs = document.querySelectorAll('#tracker_color_pickers input[type="color"]');
            colorInputs.forEach(input => {
                const trackerName = input.id.replace('color_', '');
                colors[trackerName] = input.value;
            });
            
            return Object.keys(colors).length > 0 ? colors : null;
        }
        
        // æ»‘å—å€¼æ˜¾ç¤º
        document.getElementById('rank_num').addEventListener('input', (e) => {
            document.getElementById('rank_num_val').textContent = e.target.value;
        });
        document.getElementById('legend_fontsize').addEventListener('input', (e) => {
            document.getElementById('legend_fontsize_val').textContent = e.target.value;
        });
        document.getElementById('export_rank_num').addEventListener('input', (e) => {
            document.getElementById('export_rank_num_val').textContent = e.target.value;
        });
        document.getElementById('export_legend_fontsize').addEventListener('input', (e) => {
            document.getElementById('export_legend_fontsize_val').textContent = e.target.value;
        });
        
        // ç”Ÿæˆå›¾è¡¨
        document.getElementById('generate_plot_btn').addEventListener('click', async () => {
            if (!currentSessionId) {
                showMessage('plot_status', 'è¯·å…ˆè¿›è¡Œè¯„æµ‹', 'error');
                return;
            }
            
            const plotType = document.getElementById('plot_type').value;
            const rankNum = parseInt(document.getElementById('rank_num').value);
            const legendFontsize = parseInt(document.getElementById('legend_fontsize').value);
            
            let requestData = {
                session_id: currentSessionId,
                rank_num: rankNum,
                legend_fontsize: legendFontsize,
                tracker_colors: getTrackerColors()
            };
            
            // æ ¹æ®å›¾è¡¨ç±»å‹è®¾ç½®å‚æ•°
            if (plotType === 'attr_success') {
                requestData.plot_type = 'success';
                requestData.attribute_name = document.getElementById('attr_select').value;
                if (!requestData.attribute_name) {
                    showMessage('plot_status', 'è¯·é€‰æ‹©å±æ€§', 'error');
                    return;
                }
            } else if (plotType === 'attr_precision') {
                requestData.plot_type = 'precision';
                requestData.attribute_name = document.getElementById('attr_select').value;
                if (!requestData.attribute_name) {
                    showMessage('plot_status', 'è¯·é€‰æ‹©å±æ€§', 'error');
                    return;
                }
            } else if (plotType === 'radar') {
                requestData.plot_type = 'radar';
                const checkedAttrs = document.querySelectorAll('#radar_attr_checkboxes input:checked');
                requestData.radar_attributes = Array.from(checkedAttrs).map(cb => cb.value);
                requestData.radar_metric = document.getElementById('radar_metric').value;
                
                if (requestData.radar_attributes.length < 3) {
                    showMessage('plot_status', 'é›·è¾¾å›¾è‡³å°‘éœ€è¦é€‰æ‹©3ä¸ªå±æ€§', 'error');
                    return;
                }
            } else if (plotType === 'iou_curve' || plotType === 'center_error_curve') {
                requestData.plot_type = plotType;
                requestData.seq_name = document.getElementById('seq_select').value;
                
                if (!requestData.seq_name) {
                    showMessage('plot_status', 'è¯·é€‰æ‹©è§†é¢‘åºåˆ—', 'error');
                    return;
                }
                
                const checkedTrackers = document.querySelectorAll('#iou_tracker_checkboxes input:checked');
                requestData.selected_trackers = Array.from(checkedTrackers).map(cb => cb.value);
                
                if (requestData.selected_trackers.length === 0) {
                    showMessage('plot_status', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç®—æ³•', 'error');
                    return;
                }
            } else {
                requestData.plot_type = plotType;
            }
            
            const btn = document.getElementById('generate_plot_btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>ç”Ÿæˆä¸­...';
            
            try {
                const resp = await fetch('/api/plot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestData)
                });
                const data = await resp.json();
                
                if (data.success) {
                    currentPlotImage = data.image;
                    document.getElementById('plot_container').innerHTML = 
                        `<img src="data:image/png;base64,${data.image}" alt="è¯„æµ‹å›¾è¡¨">`;
                    document.getElementById('plot_result_card').style.display = 'block';
                    showMessage('plot_status', `âœ… ${data.message}`, 'success');
                } else {
                    showMessage('plot_status', `âŒ ${data.error}`, 'error');
                }
            } catch (e) {
                showMessage('plot_status', `âŒ ç”Ÿæˆå¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ¨ ç”Ÿæˆå›¾è¡¨';
            }
        });
        
        // ä¸‹è½½å›¾è¡¨
        document.getElementById('download_plot_btn').addEventListener('click', () => {
            if (!currentPlotImage) return;
            
            const link = document.createElement('a');
            link.href = 'data:image/png;base64,' + currentPlotImage;
            link.download = 'benchmark_plot.png';
            link.click();
        });
        
        // å¯¼å‡ºç»“æœ
        document.getElementById('export_btn').addEventListener('click', async () => {
            if (!currentSessionId) {
                showMessage('export_status', 'è¯·å…ˆè¿›è¡Œè¯„æµ‹', 'error');
                return;
            }
            
            const rankNum = parseInt(document.getElementById('export_rank_num').value);
            const legendFontsize = parseInt(document.getElementById('export_legend_fontsize').value);
            
            const btn = document.getElementById('export_btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>å¯¼å‡ºä¸­...';
            
            try {
                const resp = await fetch('/api/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        rank_num: rankNum,
                        legend_fontsize: legendFontsize
                    })
                });
                
                if (resp.ok) {
                    const blob = await resp.blob();
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'benchmark_results.zip';
                    link.click();
                    URL.revokeObjectURL(url);
                    showMessage('export_status', 'âœ… å¯¼å‡ºæˆåŠŸ', 'success');
                } else {
                    const data = await resp.json();
                    showMessage('export_status', `âŒ ${data.error}`, 'error');
                }
            } catch (e) {
                showMessage('export_status', `âŒ å¯¼å‡ºå¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ“¦ å¯¼å‡ºæ‰€æœ‰ç»“æœ';
            }
        });
        
        // ========== è·Ÿè¸ªæ¡†ç»˜åˆ¶åŠŸèƒ½ ==========
        
        // æ•°æ®é›†é€‰æ‹©å˜åŒ– - æ›´æ–°ç®—æ³•å’Œåºåˆ—åˆ—è¡¨
        document.getElementById('draw_dataset').addEventListener('change', async () => {
            const ds = document.getElementById('draw_dataset').value;
            const trackerContainer = document.getElementById('draw_tracker_checkboxes');
            const seqContainer = document.getElementById('draw_seq_checkboxes');
            const colorPickers = document.getElementById('draw_tracker_color_pickers');
            
            if (!ds) {
                trackerContainer.innerHTML = '<p style="color: var(--text-secondary);">è¯·å…ˆé€‰æ‹©æ•°æ®é›†</p>';
                seqContainer.innerHTML = '<p style="color: var(--text-secondary);">è¯·å…ˆé€‰æ‹©æ•°æ®é›†</p>';
                return;
            }
            
            try {
                const resp = await fetch('/api/status');
                const data = await resp.json();
                
                // æ›´æ–°ç®—æ³•åˆ—è¡¨
                const trackers = data.trackers_by_dataset[ds] || [];
                if (trackers.length === 0) {
                    trackerContainer.innerHTML = '<p style="color: var(--text-secondary);">è¯¥æ•°æ®é›†æš‚æ— è·Ÿè¸ªç»“æœ</p>';
                } else {
                    const defaultColors = ['#ff0000', '#0000ff', '#ff00ff', '#00ffff', '#ffa500', 
                                           '#800080', '#008080', '#ff69b4', '#32cd32', '#ffd700'];
                    trackerContainer.innerHTML = '';
                    colorPickers.innerHTML = '';
                    
                    trackers.forEach((trk, i) => {
                        trackerContainer.innerHTML += `
                            <label>
                                <input type="checkbox" value="${trk}" checked>
                                ${trk}
                            </label>
                        `;
                        colorPickers.innerHTML += `
                            <div class="color-picker-item">
                                <input type="color" id="draw_color_${trk}" value="${defaultColors[i % defaultColors.length]}">
                                <span>${trk}</span>
                            </div>
                        `;
                    });
                }
                
                // æ›´æ–°åºåˆ—åˆ—è¡¨
                const sequences = data.sequences_by_dataset[ds] || [];
                if (sequences.length === 0) {
                    seqContainer.innerHTML = '<p style="color: var(--text-secondary);">è¯¥æ•°æ®é›†æš‚æ— åºåˆ—</p>';
                } else {
                    seqContainer.innerHTML = '';
                    sequences.forEach(seq => {
                        seqContainer.innerHTML += `
                            <label>
                                <input type="checkbox" value="${seq}">
                                ${seq}
                            </label>
                        `;
                    });
                }
            } catch (e) {
                trackerContainer.innerHTML = '<p style="color: var(--danger);">åŠ è½½å¤±è´¥</p>';
                seqContainer.innerHTML = '<p style="color: var(--danger);">åŠ è½½å¤±è´¥</p>';
            }
        });
        
        // çº¿æ¡ç²—ç»†æ»‘å—
        document.getElementById('draw_line_width').addEventListener('input', (e) => {
            document.getElementById('draw_line_width_val').textContent = e.target.value;
        });
        
        // è‡ªå®šä¹‰é¢œè‰²å¼€å…³
        document.getElementById('draw_enable_custom_colors').addEventListener('change', (e) => {
            document.getElementById('draw_custom_colors_config').style.display = 
                e.target.checked ? 'block' : 'none';
        });
        
        // å…¨é€‰/å–æ¶ˆå…¨é€‰åºåˆ—
        document.getElementById('draw_select_all_seq').addEventListener('click', () => {
            document.querySelectorAll('#draw_seq_checkboxes input[type="checkbox"]').forEach(cb => cb.checked = true);
        });
        document.getElementById('draw_deselect_all_seq').addEventListener('click', () => {
            document.querySelectorAll('#draw_seq_checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
        });
        
        // ç»˜åˆ¶è·Ÿè¸ªæ¡†
        document.getElementById('draw_bbox_btn').addEventListener('click', async () => {
            const dataset = document.getElementById('draw_dataset').value;
            const imagePath = document.getElementById('draw_image_path').value.trim();
            const outputPath = document.getElementById('draw_output_path').value.trim();
            const lineWidth = parseInt(document.getElementById('draw_line_width').value);
            const drawGt = document.getElementById('draw_gt').checked;
            
            if (!dataset) {
                showMessage('draw_status', 'è¯·é€‰æ‹©æ•°æ®é›†', 'error');
                return;
            }
            if (!imagePath) {
                showMessage('draw_status', 'è¯·è¾“å…¥å›¾åƒæ ¹ç›®å½•è·¯å¾„', 'error');
                return;
            }
            if (!outputPath) {
                showMessage('draw_status', 'è¯·è¾“å…¥è¾“å‡ºç›®å½•è·¯å¾„', 'error');
                return;
            }
            
            const checkedTrackers = document.querySelectorAll('#draw_tracker_checkboxes input:checked');
            const trackerNames = Array.from(checkedTrackers).map(cb => cb.value);
            
            if (trackerNames.length === 0) {
                showMessage('draw_status', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªç®—æ³•', 'error');
                return;
            }
            
            const checkedSeqs = document.querySelectorAll('#draw_seq_checkboxes input:checked');
            const seqNames = Array.from(checkedSeqs).map(cb => cb.value);
            
            if (seqNames.length === 0) {
                showMessage('draw_status', 'è¯·è‡³å°‘é€‰æ‹©ä¸€ä¸ªåºåˆ—', 'error');
                return;
            }
            
            // è·å–è‡ªå®šä¹‰é¢œè‰²
            let trackerColors = null;
            if (document.getElementById('draw_enable_custom_colors').checked) {
                trackerColors = {};
                trackerNames.forEach(trk => {
                    const colorInput = document.getElementById(`draw_color_${trk}`);
                    if (colorInput) {
                        trackerColors[trk] = colorInput.value;
                    }
                });
            }
            
            const btn = document.getElementById('draw_bbox_btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span>ç»˜åˆ¶ä¸­...';
            
            try {
                const resp = await fetch('/api/draw_bbox', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dataset_name: dataset,
                        tracker_names: trackerNames,
                        seq_names: seqNames,
                        image_base_path: imagePath,
                        output_base_path: outputPath,
                        line_width: lineWidth,
                        draw_gt: drawGt,
                        tracker_colors: trackerColors
                    })
                });
                const data = await resp.json();
                
                if (data.success) {
                    showMessage('draw_status', `âœ… ${data.message}`, 'success');
                    
                    // æ˜¾ç¤ºè¯¦ç»†ç»“æœ
                    let resultHtml = '<div class="status-box">';
                    data.results.forEach(r => {
                        resultHtml += `<div class="status-item">
                            <strong>${r.seq_name}</strong>: ${r.num_frames}å¸§<br>
                            ç®—æ³•: ${r.trackers.join(', ')}<br>
                            è¾“å‡º: ${r.output_path}
                        </div>`;
                    });
                    
                    if (data.errors && data.errors.length > 0) {
                        resultHtml += '<div style="margin-top: 10px; color: var(--warning);"><strong>è­¦å‘Š:</strong><br>';
                        data.errors.forEach(e => {
                            resultHtml += `- ${e}<br>`;
                        });
                        resultHtml += '</div>';
                    }
                    
                    resultHtml += '</div>';
                    document.getElementById('draw_results').innerHTML = resultHtml;
                    document.getElementById('draw_result_card').style.display = 'block';
                } else {
                    showMessage('draw_status', `âŒ ${data.error}`, 'error');
                    if (data.details) {
                        let detailHtml = '<ul>';
                        data.details.forEach(d => detailHtml += `<li>${d}</li>`);
                        detailHtml += '</ul>';
                        document.getElementById('draw_results').innerHTML = detailHtml;
                        document.getElementById('draw_result_card').style.display = 'block';
                    }
                }
            } catch (e) {
                showMessage('draw_status', `âŒ ç»˜åˆ¶å¤±è´¥: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ¨ å¼€å§‹ç»˜åˆ¶';
            }
        });
        
        // æ›´æ–°ç»˜åˆ¶é¡µé¢çš„æ•°æ®é›†ä¸‹æ‹‰æ¡†
        async function updateDrawDatasets() {
            try {
                const resp = await fetch('/api/status');
                const data = await resp.json();
                
                const select = document.getElementById('draw_dataset');
                select.innerHTML = '<option value="">-- è¯·é€‰æ‹©æ•°æ®é›† --</option>';
                data.datasets.forEach(ds => {
                    select.innerHTML += `<option value="${ds}">${ds}</option>`;
                });
            } catch (e) {
                console.error('æ›´æ–°ç»˜åˆ¶æ•°æ®é›†å¤±è´¥:', e);
            }
        }
        
        // åˆå§‹åŒ–
        updateStatus();
        updateDrawDatasets();
    </script>
</body>
</html>
